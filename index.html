<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¬ã‚¸ãƒ¬ã‚¸ãƒ‘ãƒ‹ãƒƒã‚¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

        * {
            font-family: 'DotGothic16', sans-serif;
            image-rendering: pixelated;
            touch-action: manipulation;
        }

        body {
            background-color: #000;
            color: #fff;
            overflow: hidden;
            margin: 0;
            transition: background-color 0.5s ease;
            height: 100vh;
            height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ãƒ–ãƒ©ã‚¦ãƒ³ç®¡ï¼ˆCRTï¼‰ã®ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³ */
        body::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.05), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.05));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .crt-flicker {
            animation: flicker 0.15s infinite;
            position: absolute;
            inset: 0;
            background: rgba(18, 16, 16, 0.05);
            pointer-events: none;
            z-index: 199;
        }

        @keyframes flicker {
            0% { opacity: 0.1; }
            50% { opacity: 0.12; }
            100% { opacity: 0.1; }
        }

        .pixel-border {
            border: 4px solid #fff;
            background: #000;
            box-shadow: 4px 4px 0px #444;
            border-radius: 0;
        }

        .pixel-button {
            border: 4px solid #fff;
            border-radius: 0;
            background: #000;
            color: #fff;
            position: relative;
            box-shadow: 4px 4px 0px #555;
            transition: all 0.05s;
            cursor: pointer;
        }
        .pixel-button:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #555;
        }
        .pixel-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        @keyframes panic-flash {
            0%, 100% { background-color: inherit; }
            50% { background-color: #500; }
        }
        .panic-mode {
            animation: panic-flash 0.2s infinite;
        }

        #game-container {
            background-image: 
                linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .mode-nightmare,
        .mode-nightmare #game-container,
        .mode-nightmare #play-screen,
        .mode-nightmare #register-box,
        .mode-nightmare #wallet-bg,
        .mode-nightmare #collection-screen,
        .mode-nightmare #pause-screen,
        .mode-nightmare #result-screen {
            background-color: #2d004d !important;
        }

        .mode-ending #game-container {
            background-color: #000 !important;
            background-image: none !important;
        }

        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle var(--duration) infinite ease-in-out;
            pointer-events: none;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 0.8; transform: scale(1); }
        }

        .ending-text-line {
            opacity: 0;
            transition: opacity 2s ease-in-out;
            position: absolute;
            width: 100%;
            text-align: center;
            top: 45%;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 650;
        }
        .ending-text-line.active {
            opacity: 1;
        }

        #eye-open-light {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 700;
            transform: scaleY(0);
            opacity: 0;
            transition: transform 2.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 1.5s ease;
            pointer-events: none;
        }
        #eye-open-light.active {
            transform: scaleY(1);
            opacity: 1;
        }

        #fin-text {
            position: fixed;
            z-index: 800;
            color: #000;
            font-size: 5rem;
            font-weight: 900;
            font-style: italic;
            letter-spacing: 0.5em;
            opacity: 0;
            transition: opacity 2s ease;
            pointer-events: none;
        }
        #fin-text.active {
            opacity: 1;
        }

        .rarity-legendary {
            color: #fbbf24;
            text-shadow: 2px 2px 0px #b91c1c, -1px -1px 0px #b91c1c, 1px -1px 0px #b91c1c, -1px 1px 0px #b91c1c, 1px 1px 0px #b91c1c;
            font-weight: 900;
        }
        .rarity-rare { color: #a78bfa; text-shadow: 1px 1px 0px #000; }
        .rarity-common { color: #94a3b8; }

        .coin-10000 { background: #550055; color: #fff; }
        .coin-5000  { background: #6b4226; color: #fff; }
        .coin-2000  { background: #2d5a27; color: #fff; }
        .coin-1000  { background: #0000AA; color: #fff; }
        .coin-500   { background: #AA5500; color: #fff; }
        .coin-100   { background: #AAAAAA; color: #000; }
        .coin-50    { background: #555555; color: #fff; }
        .coin-10    { background: #AA0000; color: #fff; }
        .coin-5     { background: #55AA00; color: #fff; }
        .coin-1     { background: #FFFFFF; color: #000; }

        .float-text {
            position: absolute;
            animation: floatUp 1s forwards steps(4);
            pointer-events: none;
            color: #ff0000;
            font-weight: bold;
            z-index: 210;
            text-shadow: 2px 2px #000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-40px); opacity: 0; }
        }

        .gold-glow { animation: gold-glow-anim 0.4s infinite steps(2); }
        @keyframes gold-glow-anim {
            0% { background: #000; color: #fbbf24; border-color: #fbbf24; }
            100% { background: #fbbf24; color: #000; border-color: #fff; }
        }

        .shake { animation: shake-anim 0.1s infinite; }
        @keyframes shake-anim {
            0% { transform: translate(0, 0); }
            25% { transform: translate(4px, 4px); }
            50% { transform: translate(-4px, 4px); }
            75% { transform: translate(4px, -4px); }
            100% { transform: translate(0, 0); }
        }

        /* çªå…¥æ™‚ã®æ¿€ã—ã„æºã‚Œ */
        @keyframes intro-shake {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 5px); }
            30% { transform: translate(-5px, 10px); }
            40% { transform: translate(5px, -5px); }
            50% { transform: translate(-10px, 5px); }
            60% { transform: translate(10px, -10px); }
            70% { transform: translate(-5px, -5px); }
            80% { transform: translate(5px, 10px); }
            90% { transform: translate(-10px, -5px); }
            100% { transform: translate(0, 0); }
        }
        .intro-shaking {
            animation: intro-shake 0.1s infinite;
        }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div class="crt-flicker"></div>

    <!-- ãƒŠã‚¤ãƒˆãƒ¡ã‚¢é–‹å§‹æ¼”å‡º -->
    <div id="nightmare-intro-overlay" class="hidden fixed inset-0 z-[1500] bg-red-900/80 flex flex-col items-center justify-center pointer-events-none">
        <div class="text-6xl font-black text-white italic mb-4" style="text-shadow: 4px 4px #000;">NIGHTMARE</div>
        <div class="text-2xl font-bold text-white tracking-[1em]">STARTING...</div>
    </div>

    <!-- ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="ending-screen" class="hidden fixed inset-0 z-[600] bg-black overflow-hidden flex flex-col items-center justify-center text-center">
        <div id="star-container" class="absolute inset-0 pointer-events-none"></div>
        
        <div id="ending-text-container" class="relative w-full h-full flex items-center justify-center">
            <p class="ending-text-line text-2xl text-white px-6" data-step="1">ã‚ˆãã“ã®æ‚ªå¤¢ã‹ã‚‰ç›®ã‚’è¦šã¾ã—ãŸ</p>
            <div class="ending-text-line px-6" data-step="2">
                <span class="text-sm text-gray-500 block mb-2 tracking-widest">ç§°å·</span>
                <span class="text-5xl rarity-legendary">å¤¢ã‚’è¶…ãˆã¦ãƒ»ãƒ»ãƒ»</span>
            </div>
            <p class="ending-text-line text-xl text-gray-400 px-6" data-step="3">ãŠé‡£ã‚Šã‚’å°‘ãªãã™ã‚‹</p>
            <p class="ending-text-line text-4xl text-yellow-400 font-black px-6 tracking-widest" data-step="4">ã“ã‚Œã“ããŒå¤§äººã®å—œã¿</p>
            <p class="ending-text-line text-3xl text-white px-6 italic" data-step="5">ã•ãç¾å®Ÿä¸–ç•Œã¸</p>
        </div>

        <div id="eye-open-light"></div>
        <div id="fin-text">FIN</div>

        <div id="ending-skip" class="absolute bottom-10 z-[900] opacity-0 transition-opacity duration-1000">
            <button onclick="location.reload()" class="pixel-button px-8 py-3 text-lg bg-black text-white font-black">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
        </div>
    </div>

    <div class="fixed top-4 right-4 z-[500] flex gap-2">
        <button id="pause-btn-global" onclick="togglePause()" class="hidden w-10 h-10 pixel-border flex items-center justify-center bg-black text-white hover:bg-gray-800">
            <span id="pause-icon-global">II</span>
        </button>
        <button id="mute-btn" onclick="Sound.toggleMute()" class="w-10 h-10 pixel-border flex items-center justify-center bg-black text-white hover:bg-gray-800">
            <span id="mute-icon">ğŸµ</span>
        </button>
    </div>

    <div id="game-container" class="relative w-full max-w-md h-full max-h-[760px] flex flex-col overflow-hidden border-4 border-white transition-all duration-300">
        
        <!-- START SCREEN -->
        <div id="start-screen" class="absolute inset-0 z-[120] flex flex-col items-center justify-center bg-black p-8 text-center border-white">
            <div class="relative mb-6">
                <div id="secret-trigger" onclick="tapSecret()" class="text-7xl animate-bounce cursor-pointer select-none">ğŸ’°</div>
                <!-- å…¨çŸ¥å…¨èƒ½ã®å®¢ç²å¾—å¾Œã®ãƒ’ãƒ³ãƒˆ -->
                <div id="nightmare-hint" class="hidden absolute -bottom-4 left-1/2 -translate-x-1/2 text-[10px] text-red-500 font-bold whitespace-nowrap animate-pulse">ğŸ’°x10...ï¼Ÿ</div>
            </div>
            <h1 class="text-4xl font-black text-yellow-400 mb-2 leading-tight tracking-widest text-shadow">ãƒ¬ã‚¸ãƒ¬ã‚¸ãƒ‘ãƒ‹ãƒƒã‚¯</h1>
            <div class="pixel-border p-5 mb-6 text-left text-xs text-white w-full bg-gray-900/50">
                <p class="font-bold text-yellow-400 mb-2">ã€ãƒ«ãƒ¼ãƒ«ã€‘</p>
                <ul class="list-none space-y-1">
                    <li>ãƒ»å…¨ 10 å• / åˆ¶é™æ™‚é–“ 15ç§’</li>
                    <li>ãƒ»ãŠé‡£ã‚Šã®ç´¯è¨ˆæšæ•°ã‚’æœ€å°ã«ã›ã‚ˆ</li>
                    <li>ãƒ»è²¡å¸ƒãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹æ´»ç”¨ã›ã‚ˆ</li>
                </ul>
            </div>
            
            <div class="w-full space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startGame('normal')" class="pixel-button py-4 text-xl font-bold bg-white text-black active:bg-yellow-400">Normal</button>
                    <button onclick="startGame('hard')" class="pixel-button py-4 text-xl font-bold bg-red-600 text-white active:bg-red-500">Hard</button>
                </div>
                <button onclick="showEndlessHome()" class="pixel-button w-full py-4 text-xl font-bold bg-green-600 text-white active:bg-green-500">Endless</button>
                <button onclick="toggleCollection(true)" class="pixel-button w-full py-2 text-sm font-bold bg-blue-900 text-white">ç§°å·å›³é‘‘</button>
            </div>
        </div>

        <!-- ENDLESS HOME SCREEN -->
        <div id="endless-home-screen" class="hidden absolute inset-0 z-[125] flex flex-col items-center justify-center bg-black p-8 text-center">
            <h2 class="text-4xl font-black text-green-500 mb-2 tracking-widest italic uppercase">ENDLESS</h2>
            <div class="pixel-border p-4 mb-6 w-full bg-green-900/20">
                <p class="text-gray-400 text-xs mb-1">PERSONAL BEST</p>
                <p id="endless-best-display" class="text-4xl font-black text-white">STAGE 0</p>
            </div>
            <div class="pixel-border p-5 mb-8 text-left text-xs text-white w-full bg-gray-900/50">
                <p class="font-bold text-green-500 mb-2">ã€ãƒ«ãƒ¼ãƒ«ã€‘</p>
                <ul class="list-none space-y-2">
                    <li>ãƒ»ãŠé‡£ã‚Šã®ç´¯è¨ˆãŒ <span class="text-red-500 font-bold text-sm">20æš</span> ã«ãªã‚‹ã¨çµ‚äº†</li>
                    <li>ãƒ»ãŠé‡£ã‚Š <span class="text-yellow-400 font-bold text-sm">0æš (PERFECT)</span> ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å›å¾©ï¼†ãŠé‡£ã‚Š-1æš</li>
                    <li>ãƒ»ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã¯æœ€å¤§ <span class="text-yellow-400 font-bold text-sm">2å€‹</span> ã¾ã§ä¿æŒå¯èƒ½</li>
                </ul>
            </div>
            <button onclick="startGame('endless')" class="pixel-button w-full py-5 text-2xl font-bold bg-white text-black mb-3">é–‹å§‹ã™ã‚‹</button>
            <button onclick="hideEndlessHome()" class="text-sm text-gray-500 underline">æˆ»ã‚‹</button>
        </div>

        <!-- PLAY SCREEN -->
        <div id="play-screen" class="hidden flex-col h-full bg-transparent">
            <!-- Header -->
            <div class="p-3 bg-black/80 border-b-4 border-white flex-none">
                <div class="flex justify-between items-center mb-1 text-xs sm:text-sm font-bold relative">
                    <span id="question-count" onclick="handleSecretEndingTap()" class="bg-blue-800 px-2 py-1 cursor-pointer select-none">STAGE 1</span>
                    <div class="flex flex-col items-center">
                        <span id="cumulative-label" class="text-[8px] text-gray-400 leading-none mb-1 uppercase">Cumulative Change</span>
                        <span id="cumulative-change-count" class="text-base sm:text-lg text-yellow-400 leading-none">0æš</span>
                    </div>
                    <span id="timer-label" class="text-xl text-yellow-400 tabular-nums">15.00s</span>
                </div>
                <div class="w-full bg-gray-800 h-3 border-2 border-white overflow-hidden">
                    <div id="timer-bar" class="h-full bg-blue-500 w-full transition-all duration-100"></div>
                </div>
            </div>

            <!-- Register Area -->
            <div class="flex-1 flex flex-col items-center justify-center p-4 relative bg-transparent min-h-0">
                <div id="pressure-overlay" class="absolute inset-0 pointer-events-none"></div>
                <div id="register-box" class="pixel-border p-4 sm:p-6 w-full flex flex-col items-center relative transition-transform">
                    <div class="absolute -top-4 left-4 bg-white text-black px-2 py-0.5 text-[10px] font-bold">POS SYSTEM</div>
                    <div class="w-full text-center mb-4 sm:mb-8">
                        <p class="text-gray-400 text-[10px] mb-1 font-bold uppercase">Amount Due</p>
                        <div id="price-display" class="text-4xl sm:text-5xl font-black text-green-400 tracking-tighter">Â¥0</div>
                    </div>
                    <div class="w-full border-t-4 border-dotted border-gray-700 pt-4 sm:pt-8">
                        <p class="text-center text-[10px] text-blue-400 mb-1 font-bold uppercase">Tendered Amount</p>
                        <div id="input-display" class="text-3xl sm:text-4xl font-black text-blue-500 text-center">Â¥0</div>
                    </div>
                </div>
                <div id="clerk-reaction" class="mt-4 text-center font-black text-xl h-10 tracking-widest text-yellow-400"></div>
            </div>

            <!-- Wallet Panel -->
            <div id="wallet-bg" class="bg-black/90 p-3 pb-6 border-t-4 border-white flex-none">
                <div class="flex justify-between items-center mb-3 px-1 relative">
                    <span id="difficulty-badge" class="text-[10px] font-black tracking-widest text-black bg-white px-2 py-0.5 uppercase">NORMAL</span>
                    <button id="refresh-item-btn" onclick="useRefreshItem()" class="absolute left-1/2 -translate-x-1/2 text-[9px] font-black text-yellow-400 border-2 border-yellow-400 px-3 py-0.5 active:bg-yellow-400 active:text-black disabled:border-gray-600 disabled:text-gray-600 transition-all whitespace-nowrap">
                        REFRESH WALLET (3)
                    </button>
                    <div class="flex gap-4">
                        <button id="undo-btn" onclick="undoInput()" class="text-[10px] font-black text-white underline decoration-2 underline-offset-4">Undo</button>
                        <button onclick="resetInput()" class="text-[10px] font-black text-white underline decoration-2 underline-offset-4">Reset</button>
                    </div>
                </div>
                <!-- æ±ºå®šãƒœã‚¿ãƒ³ã‚’çµ±åˆã—ãŸ4åˆ—ã‚°ãƒªãƒƒãƒ‰ -->
                <div id="coin-grid" class="grid grid-cols-4 gap-1.5 sm:gap-2"></div>
            </div>
        </div>

        <!-- COLLECTION SCREEN -->
        <div id="collection-screen" class="hidden absolute inset-0 z-[130] flex flex-col bg-black p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-yellow-400 tracking-widest">ç§°å·å›³é‘‘</h2>
                <button onclick="toggleCollection(false)" class="text-xl font-bold">Ã—é–‰ã˜ã‚‹</button>
            </div>
            <div id="title-list" class="space-y-4"></div>
        </div>

        <!-- PAUSE SCREEN -->
        <div id="pause-screen" class="hidden absolute inset-0 z-[140] flex flex-col items-center justify-center bg-black/80 p-8 text-center">
            <div class="w-full space-y-4">
                <button onclick="togglePause()" class="pixel-button w-full py-5 text-2xl font-bold bg-white text-black">å†é–‹ã™ã‚‹</button>
                <button onclick="location.reload()" class="pixel-button w-full py-3 text-lg font-bold bg-red-900 text-white">ã‚¿ã‚¤ãƒˆãƒ«</button>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen" class="hidden absolute inset-0 z-[120] flex flex-col items-center justify-center bg-black p-8 text-center border-4 border-white">
            <div class="text-yellow-400 text-2xl font-black mb-1 tracking-widest uppercase" id="result-status">STAGE COMPLETE</div>
            
            <!-- ç§°å·è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="result-rank" class="text-3xl font-black text-white mb-10 leading-tight relative">
                ç§°å·:<br><span id="final-rank-text" class="text-4xl sm:text-5xl text-yellow-400 italic block mt-2 underline decoration-4 underline-offset-8">åº¶æ°‘</span>
                <!-- æ–°è¦ç²å¾—ãƒãƒƒã‚¸ -->
                <div id="new-title-badge" class="hidden absolute -top-4 -right-10 bg-red-600 text-white text-[10px] px-2 py-1 animate-bounce border-2 border-white">NEW!</div>
                <div id="new-record-badge" class="hidden absolute -top-4 -right-8 bg-red-600 text-white text-[10px] px-2 py-1 animate-bounce border-2 border-white">NEW RECORD!</div>
            </div>

            <div class="w-full grid grid-cols-1 gap-4 mb-10">
                <div class="pixel-border p-4">
                    <p id="result-stat-label" class="text-[10px] text-gray-500 font-bold mb-1 uppercase">TOTAL CHANGE COINS</p>
                    <p id="total-change-coins" class="text-3xl font-black text-white">0æš</p>
                </div>
            </div>
            <button onclick="location.reload()" class="pixel-button w-full py-5 bg-white text-black font-black text-xl">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
    </div>

    <div id="floating-area" class="fixed inset-0 pointer-events-none z-[1100]"></div>

    <script>
        const ALL_TITLES = [
            { id: "nightmare-god", name: "å¤¢ã‚’è¶…ãˆã¦ãƒ»ãƒ»ãƒ»", rarity: "legendary", order: 0, condition: "???ã§ãŠé‡£ã‚Š 10æšä»¥ä¸‹" },
            { id: "collector-king", name: "å…¨çŸ¥å…¨èƒ½ã®å®¢", rarity: "legendary", order: 1, condition: "ãƒ¬ã‚¢ã¨ã‚³ãƒ¢ãƒ³ã®ç§°å·ã‚’å…¨ã¦ç²å¾—" },
            { id: "nightmare-conqueror", name: "æ‚ªå¤¢ã‚’è¶…è¶Šã™ã‚‹å­˜åœ¨", rarity: "rare", order: 2, condition: "???ã§ãŠé‡£ã‚Š 20æšä»¥ä¸‹" },
            { id: "hard-god", name: "ãŠä¼šè¨ˆã‚’å¸ã‚‹è€…", rarity: "rare", order: 3, condition: "Hardã§ãŠé‡£ã‚Š 20æšä»¥ä¸‹" },
            { id: "normal-god", name: "ãŠä¼šè¨ˆã®å®ˆè­·ç¥", rarity: "rare", order: 4, condition: "Normalã§ãŠé‡£ã‚Š 20æšä»¥ä¸‹" },
            { id: "god", name: "ä¼èª¬ã®ä¼šè¨ˆå¸«", rarity: "rare", order: 5, condition: "ç´¯è¨ˆãŠé‡£ã‚Š 30æšä»¥ä¸‹" },
            { id: "wizard", name: "æ”¯æ‰•ã„ã®é­”è¡“å¸«", rarity: "common", order: 6, condition: "ç´¯è¨ˆãŠé‡£ã‚Š 50æšä»¥ä¸‹" },
            { id: "normal", name: "ãƒ¬ã‚¸æ…£ã‚Œã—ãŸå®¢", rarity: "common", order: 7, condition: "ç´¯è¨ˆãŠé‡£ã‚Š 70æšä»¥ä¸‹" },
            { id: "heavy", name: "å°éŠ­ã«æ„›ã•ã‚ŒãŸè€…", rarity: "common", order: 8, condition: "ç´¯è¨ˆãŠé‡£ã‚Š 90æšä»¥ä¸‹" },
            { id: "pan-man", name: "è²¡å¸ƒãƒ‘ãƒ³ãƒ‘ãƒ³ãƒãƒ³", rarity: "common", order: 9, condition: "ãŠç´¯è¨ˆãŠé‡£ã‚Š 91æšä»¥ä¸Š" }
        ];

        const Sound = {
            ctx: null, isMuted: false, bgmTimer: null, bgmTempo: 0.18, bgmIndex: 0,
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); },
            toggleMute() { this.isMuted = !this.isMuted; document.getElementById('mute-icon').innerText = this.isMuted ? 'âŒ' : 'ğŸµ'; if (this.isMuted) this.stopBGM(); else if (state.currentStep > 0) this.startBGM(); },
            play(freq, type, duration, vol = 0.1, delay = 0) { 
                if (!this.ctx || this.isMuted) return; 
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); const now = this.ctx.currentTime + delay;
                osc.type = type; osc.frequency.setValueAtTime(freq, now); gain.gain.setValueAtTime(vol, now); gain.gain.exponentialRampToValueAtTime(0.001, now + duration); 
                osc.connect(gain); gain.connect(this.ctx.destination); osc.start(now); osc.stop(now + duration); 
            },
            startBGM() { 
                if (this.isMuted || this.bgmTimer) return; 
                const normalSequence = [[130.81, 261.63, 329.63, 392.00], [146.83, 293.66, 349.23, 440.00], [164.81, 329.63, 392.00, 493.88], [174.61, 349.23, 440.00, 523.25]];
                const nightmareSequence = [[65.41, 130.81, 155.56, 185.00], [61.74, 123.47, 146.83, 174.61], [55.00, 110.00, 130.81, 155.56], [61.74, 123.47, 155.56, 185.00], [65.41, 196.00, 233.08, 277.18], [69.30, 207.65, 246.94, 293.66], [73.42, 220.00, 261.63, 311.13], [77.78, 233.08, 277.18, 329.63]];
                const endingSequence = [[261.63, 329.63, 392.00, 523.25], [329.63, 392.00, 493.88, 659.25], [349.23, 440.00, 523.25, 698.46], [392.00, 493.88, 587.33, 783.99]];
                this.bgmTimer = setInterval(() => { 
                    let seq = state.isEnding ? endingSequence : (state.difficulty === 'nightmare' ? nightmareSequence : normalSequence);
                    const chord = seq[this.bgmIndex % seq.length];
                    const tempo = state.isEnding ? 0.6 : this.bgmTempo;
                    const panicMultiplier = (!state.isEnding && state.timeLeft < 5) ? 1.2 : 1; 
                    this.play(chord[0] * panicMultiplier, state.isEnding ? 'sine' : 'sawtooth', tempo * 2.1, 0.05);
                    this.play(chord[1] * panicMultiplier, state.isEnding ? 'sine' : 'square', tempo, 0.03);
                    this.play(chord[2] * panicMultiplier, 'triangle', tempo, 0.02, 0.02);
                    this.play(chord[3] * panicMultiplier, 'sine', tempo, 0.02, 0.04);
                    if (state.difficulty === 'nightmare' && !state.isEnding) this.play(50, 'sine', 0.02, 0.015);
                    this.bgmIndex++; 
                }, (state.isEnding ? 0.6 : (!state.isEnding && state.timeLeft < 5 ? this.bgmTempo * 0.9 : this.bgmTempo)) * 1000); 
            },
            stopBGM() { if (this.bgmTimer) { clearInterval(this.bgmTimer); this.bgmTimer = null; } },
            coin() { this.play(880, 'square', 0.1, 0.08); },
            click() { this.play(440, 'sine', 0.05, 0.05); },
            perfect() { this.play(523.25, 'square', 0.1); setTimeout(() => this.play(659.25, 'square', 0.1), 100); setTimeout(() => this.play(783.99, 'square', 0.2), 200); },
            good() { this.play(600, 'sine', 0.2); },
            fail() { this.play(150, 'sawtooth', 0.3, 0.2); this.play(110, 'sawtooth', 0.3, 0.2); },
            warn() { this.play(200, 'sine', 0.1, 0.03); },
            powerup() { this.play(440, 'square', 0.1); setTimeout(() => this.play(660, 'square', 0.1), 100); setTimeout(() => this.play(880, 'square', 0.2), 200); },
            glitch() { for(let i=0; i<15; i++) { setTimeout(() => this.play(Math.random()*200 + 40, 'sawtooth', 0.1, 0.2), i*50); } }
        };

        const COIN_TYPES = [
            { val: 10000, label: "10,000", class: "coin-10000" }, { val: 5000, label: "5,000", class: "coin-5000" },
            { val: 2000, label: "2,000", class: "coin-2000" }, { val: 1000, label: "1,000", class: "coin-1000" },
            { val: 500, label: "500", class: "coin-500" }, { val: 100, label: "100", class: "coin-100" },
            { val: 50, label: "50", class: "coin-50" }, { val: 10, label: "10", class: "coin-10" },
            { val: 5, label: "5", class: "coin-5" }, { val: 1, label: "1", class: "coin-1" }
        ];

        let state = {
            currentStep: 0, totalSteps: 10, price: 0, wallet: {}, initialWallet: {}, inputAmount: 0, timeLeft: 15, 
            timer: null, totalChangeCoins: 0, isPaused: false, difficulty: 'normal', secretTaps: 0, 
            history: [], itemsRemaining: 0, itemsMax: 2, isEnding: false, secretEndingCount: 0,
            isTransitioning: false 
        };

        const PRESSURE_MESSAGES = ["æ—©ãã—ã¦â€¦", "ãƒãƒƒ...", "ãƒã‚¡...", "å¾Œã‚ãŒè©°ã¾ã£ã¦ã‚‹ï¼", "å°éŠ­å¤šã„ãªâ€¦"];

        // åˆæœŸåŒ–ï¼šãƒ’ãƒ³ãƒˆã®è¡¨ç¤ºãƒã‚§ãƒƒã‚¯
        window.addEventListener('DOMContentLoaded', () => {
            const earned = getEarnedTitles();
            if (earned.includes("collector-king")) {
                document.getElementById('nightmare-hint').classList.remove('hidden');
            }
        });

        function tapSecret() {
            state.secretTaps++; Sound.init(); Sound.click();
            if (state.secretTaps >= 10) { 
                state.secretTaps = 0;
                triggerNightmareIntro(); 
            }
        }

        function handleSecretEndingTap() {
            if (state.currentStep === 0 || state.isEnding) return;
            state.secretEndingCount++; Sound.click();
            if (state.secretEndingCount >= 7) { state.secretEndingCount = 0; playEnding(); }
        }

        function triggerNightmareIntro() {
            Sound.glitch(); 
            const overlay = document.getElementById('nightmare-intro-overlay');
            overlay.classList.remove('hidden'); 
            document.body.classList.add('intro-shaking'); // æºã‚Œé–‹å§‹
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                document.body.classList.remove('intro-shaking'); // æºã‚Œçµ‚äº†
                startGame('nightmare'); 
            }, 1800);
        }

        function showEndlessHome() { Sound.init(); Sound.click(); const best = localStorage.getItem('endless_best_stage') || 0; document.getElementById('endless-best-display').innerText = `STAGE ${best}`; document.getElementById('start-screen').classList.add('hidden'); document.getElementById('endless-home-screen').classList.remove('hidden'); }
        function hideEndlessHome() { Sound.click(); document.getElementById('start-screen').classList.remove('hidden'); document.getElementById('endless-home-screen').classList.add('hidden'); }

        function startGame(difficulty) {
            state.difficulty = difficulty; state.totalChangeCoins = 0; state.currentStep = 0; state.isPaused = false; state.isEnding = false;
            if (difficulty === 'normal') { state.itemsRemaining = 3; state.itemsMax = 3; state.totalSteps = 10; }
            else if (difficulty === 'hard') { state.itemsRemaining = 2; state.itemsMax = 2; state.totalSteps = 10; }
            else if (difficulty === 'nightmare') { state.itemsRemaining = 1; state.itemsMax = 1; state.totalSteps = 10; }
            else if (difficulty === 'endless') { state.itemsRemaining = 2; state.itemsMax = 2; state.totalSteps = Infinity; }

            Sound.init(); Sound.click(); 
            if (difficulty === 'nightmare') document.body.classList.add('mode-nightmare'); else document.body.classList.remove('mode-nightmare');
            Sound.startBGM();
            document.getElementById('start-screen').classList.add('hidden'); document.getElementById('endless-home-screen').classList.add('hidden');
            document.getElementById('play-screen').classList.remove('hidden'); document.getElementById('play-screen').classList.add('flex');
            document.getElementById('pause-btn-global').classList.remove('hidden');
            nextQuestion();
        }

        function nextQuestion() {
            if (state.currentStep >= state.totalSteps) { showResult(); return; }
            state.currentStep++; state.inputAmount = 0; state.timeLeft = 15; state.history = []; 
            state.isTransitioning = true; 

            let basePrice = 0;
            if (state.difficulty === 'nightmare') basePrice = Math.floor(Math.random() * 142000) + 8000;
            else if (state.difficulty === 'hard' || state.difficulty === 'endless') basePrice = Math.floor(Math.random() * 26800) + 1200;
            else basePrice = Math.floor(Math.random() * 3350) + 150;
            state.price = basePrice;

            const newWallet = generateWallet(state.price); state.wallet = {...newWallet}; state.initialWallet = {...newWallet};
            updateUI(); 
            startTimer();

            setTimeout(() => {
                state.isTransitioning = false;
                updateUI();
            }, 500);
        }

        function calculateTotal(wallet) { return Object.keys(wallet).reduce((acc, key) => acc + (wallet[key] * parseInt(key)), 0); }

        function generateWallet(price) {
            let w = {}; COIN_TYPES.forEach(c => w[c.val] = 0);
            w[500] = Math.floor(Math.random() * 3); w[100] = Math.floor(Math.random() * 6) + 1;       
            w[50]  = Math.floor(Math.random() * 3); w[10]  = Math.floor(Math.random() * 8) + 1;       
            w[5]   = Math.floor(Math.random() * 3); w[1]   = Math.floor(Math.random() * 10);          

            if (state.difficulty === 'nightmare') {
                w[10000] = Math.floor(price / 10000) + 1; w[5000] = Math.floor(Math.random() * 2) + 1;
                w[2000] = Math.random() > 0.5 ? Math.floor(Math.random() * 3) : 0; w[1000] = Math.floor(Math.random() * 6) + 2; 
            } else if (state.difficulty === 'hard' || state.difficulty === 'endless') {
                w[10000] = Math.floor(price / 10000) > 0 ? Math.floor(price / 10000) + 1 : 0;
                w[5000] = Math.floor(Math.random() * 2) + (w[10000] === 0 ? 1 : 0);
                w[2000] = Math.random() > 0.7 ? 1 : 0;
                w[1000] = Math.ceil((price % 10000) / 1000) + Math.floor(Math.random() * 5);
            } else {
                w[1000] = Math.ceil(price / 1000) + Math.floor(Math.random() * 3);
                if (price >= 5000) w[5000] = 1;
            }
            let currentTotal = calculateTotal(w);
            while (currentTotal < price) { if (price >= 10000) w[10000]++; else w[1000]++; currentTotal = calculateTotal(w); }
            return w;
        }

        function useRefreshItem() { if (state.itemsRemaining <= 0 || state.isPaused) return; Sound.powerup(); state.itemsRemaining--; const newWallet = generateWallet(state.price); state.wallet = {...newWallet}; state.initialWallet = {...newWallet}; state.inputAmount = 0; state.history = []; updateUI(); }

        function updateUI() {
            if (state.difficulty === 'endless') {
                document.getElementById('question-count').innerText = `STAGE ${state.currentStep}`;
                document.getElementById('cumulative-label').innerText = "Coins / Limit";
                document.getElementById('cumulative-change-count').innerHTML = `${state.totalChangeCoins} <span class="text-red-500 text-xs">/ 20</span>`;
            } else {
                document.getElementById('question-count').innerText = `STAGE ${state.currentStep} / ${state.totalSteps}`;
                document.getElementById('cumulative-label').innerText = "Cumulative Change";
                document.getElementById('cumulative-change-count').innerText = `${state.totalChangeCoins}æš`;
            }
            document.getElementById('price-display').innerText = `Â¥${state.price.toLocaleString()}`;
            document.getElementById('input-display').innerText = `Â¥${state.inputAmount.toLocaleString()}`;
            document.getElementById('difficulty-badge').innerText = state.difficulty.toUpperCase();
            const itemBtn = document.getElementById('refresh-item-btn');
            if (state.itemsRemaining > 0) { itemBtn.disabled = false; itemBtn.innerText = `REFRESH WALLET (${state.itemsRemaining})`; } 
            else { itemBtn.disabled = true; itemBtn.innerText = "USED (0)"; }

            const grid = document.getElementById('coin-grid'); grid.innerHTML = '';
            COIN_TYPES.forEach(coin => {
                const count = state.wallet[coin.val] || 0;
                const btn = document.createElement('button');
                btn.className = `coin pixel-button relative flex flex-col items-center justify-center py-2 ${coin.class} ${count === 0 ? 'opacity-20 grayscale pointer-events-none' : ''}`;
                btn.innerHTML = `<span class="text-[9px] font-black">${coin.label}</span><span class="text-[9px] font-bold opacity-80 leading-none mt-1">x${count}</span>`;
                btn.onclick = () => { if(state.isPaused) return; Sound.coin(); state.wallet[coin.val]--; state.inputAmount += coin.val; state.history.push(coin.val); updateUI(); };
                grid.appendChild(btn);
            });

            const payBtn = document.createElement('button'); 
            const isShort = state.inputAmount < state.price;
            const isLocked = state.isTransitioning; 
            payBtn.className = `pixel-button col-span-2 py-2 flex items-center justify-center text-sm font-black transition-colors ${(isShort || isLocked) ? 'bg-gray-800 text-gray-500 opacity-50' : 'bg-yellow-500 text-black active:bg-yellow-400'}`;
            payBtn.innerText = isLocked ? "READY..." : (isShort ? "è¶³ã‚Šã¾ã›ã‚“" : "æ”¯æ‰•ã†ï¼"); 
            payBtn.disabled = isShort || isLocked;
            payBtn.onclick = () => { if(!isShort && !isLocked) handlePay(); };
            grid.appendChild(payBtn);
        }

        function resetInput() { if(state.isPaused) return; Sound.click(); state.wallet = {...state.initialWallet}; state.inputAmount = 0; state.history = []; updateUI(); }
        function undoInput() { if(state.isPaused || state.history.length === 0) return; Sound.click(); const lastVal = state.history.pop(); state.wallet[lastVal]++; state.inputAmount -= lastVal; updateUI(); }

        function startTimer() {
            if (state.timer) clearInterval(state.timer);
            const bar = document.getElementById('timer-bar');
            const label = document.getElementById('timer-label');
            const container = document.getElementById('game-container');
            state.timer = setInterval(() => {
                if (state.isPaused) return;
                state.timeLeft -= 0.05; const percent = (state.timeLeft / 15) * 100; bar.style.width = `${percent}%`; label.innerText = `${Math.max(0, state.timeLeft).toFixed(2)}s`;
                if (percent < 30) { bar.classList.replace('bg-blue-500', 'bg-red-500'); container.classList.add('panic-mode'); if (Math.round(state.timeLeft * 10) % 5 === 0) Sound.warn(); if (Math.random() < 0.04) spawnPressureText(); } 
                else { bar.classList.replace('bg-red-500', 'bg-blue-500'); container.classList.remove('panic-mode'); }
                if (state.timeLeft <= 0) { clearInterval(state.timer); timeUp(); }
            }, 50);
        }

        function togglePause() { if (state.currentStep === 0) return; Sound.click(); state.isPaused = !state.isPaused; const ps = document.getElementById('pause-screen'); const pi = document.getElementById('pause-icon-global'); if (state.isPaused) { ps.classList.remove('hidden'); pi.innerText = "â–¶"; } else { ps.classList.add('hidden'); pi.innerText = "II"; } }
        function spawnPressureText() { if(state.isPaused) return; const area = document.getElementById('floating-area'); const txt = document.createElement('div'); txt.className = 'float-text'; txt.style.left = (Math.random() * 60 + 20) + '%'; txt.style.top = (Math.random() * 40 + 30) + '%'; txt.innerText = PRESSURE_MESSAGES[Math.floor(Math.random() * PRESSURE_MESSAGES.length)]; area.appendChild(txt); setTimeout(() => txt.remove(), 1000); }

        function handlePay() {
            if(state.isPaused || state.isTransitioning || state.inputAmount < state.price) return;
            clearInterval(state.timer); 
            state.isTransitioning = true; // 1åº¦æŠ¼ã—ãŸã‚‰ãƒ­ãƒƒã‚¯
            updateUI();

            const change = state.inputAmount - state.price; const changeCount = calculateCoinCount(change);
            let msg = ""; let colorClass = "";
            if (change === 0) { 
                Sound.perfect(); msg = "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼"; colorClass = "gold-glow"; 
                if (state.difficulty === 'endless') { if (state.itemsRemaining < state.itemsMax) state.itemsRemaining++; state.totalChangeCoins = Math.max(0, state.totalChangeCoins - 1); }
            } else if (changeCount <= 3) { Sound.good(); msg = "ã‚¹ãƒãƒ¼ãƒˆï¼"; colorClass = "text-green-500"; } 
            else if (changeCount >= 10) { Sound.fail(); msg = "å°éŠ­ãŒå¤šã™ãã‚‹ï¼ï¼"; colorClass = "text-red-600"; document.getElementById('register-box').classList.add('shake'); } 
            else { Sound.good(); msg = "ãŠé‡£ã‚Šå¤šã‚..."; colorClass = "text-blue-500"; }
            
            if (change > 0) state.totalChangeCoins += changeCount;
            const reaction = document.getElementById('clerk-reaction'); reaction.className = `mt-4 text-center font-black text-xl h-10 transition-all ${colorClass}`; reaction.innerText = msg;
            setTimeout(() => { reaction.innerText = ""; reaction.className = "mt-4 text-center font-black text-xl h-10"; document.getElementById('register-box').classList.remove('shake'); if (state.difficulty === 'endless' && state.totalChangeCoins >= 20) showResult(); else if (state.currentStep >= state.totalSteps) showResult(); else nextQuestion(); }, 1600);
        }

        function calculateCoinCount(amount) { let count = 0; let temp = amount; [10000, 5000, 2000, 1000, 500, 100, 50, 10, 5, 1].forEach(c => { count += Math.floor(temp / c); temp %= c; }); return count; }
        function timeUp() { if(state.isTransitioning) return; Sound.fail(); state.inputAmount = Math.ceil(state.price / 1000) * 1000; handlePay(); }
        function getEarnedTitles() { return JSON.parse(localStorage.getItem('cashier_panic_titles') || '[]'); }
        function saveEarnedTitle(id) { const earned = getEarnedTitles(); if (!earned.includes(id)) { earned.push(id); localStorage.setItem('cashier_panic_titles', JSON.stringify(earned)); return true; } return false; }

        function toggleCollection(show) {
            Sound.click(); const screen = document.getElementById('collection-screen');
            if (show) {
                const earned = getEarnedTitles(); const rarityMap = { legendary: 0, rare: 1, common: 2 };
                const sortedTitles = [...ALL_TITLES].sort((a, b) => rarityMap[a.rarity] - rarityMap[b.rarity] || a.order - b.order);
                document.getElementById('title-list').innerHTML = sortedTitles.map(title => {
                    const isEarned = earned.includes(title.id); let cardClass = isEarned ? 'bg-gray-900' : 'bg-gray-900 opacity-40';
                    return `<div class="pixel-border p-3 ${cardClass} ${isEarned ? (title.rarity === 'legendary' ? 'border-red-600 border-2' : 'border-gray-500') : 'border-gray-800'}">
                        <div class="flex justify-between items-center mb-1"><span class="text-lg font-bold ${isEarned ? `rarity-${title.rarity}` : 'text-gray-600'}">${isEarned ? title.name : 'ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ'}</span><span class="text-[8px] font-black uppercase rarity-${title.rarity}">${title.rarity}</span></div>
                        <p class="text-[9px] text-gray-500">æ¡ä»¶: ${title.condition}</p></div>`;
                }).join('');
                screen.classList.remove('hidden');
            } else screen.classList.add('hidden');
        }

        function createStars() {
            const container = document.getElementById('star-container'); container.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div'); star.className = 'star'; const size = Math.random() * 3 + 1 + 'px'; star.style.width = size; star.style.height = size; star.style.left = Math.random() * 100 + '%'; star.style.top = Math.random() * 100 + '%'; star.style.setProperty('--duration', Math.random() * 3 + 2 + 's'); star.style.animationDelay = Math.random() * 5 + 's'; container.appendChild(star);
            }
        }

        function playEnding() {
            state.isEnding = true; document.body.classList.add('mode-ending');
            document.getElementById('play-screen').classList.add('hidden'); document.getElementById('ending-screen').classList.remove('hidden');
            createStars(); Sound.stopBGM(); Sound.startBGM();
            const textLines = document.querySelectorAll('.ending-text-line'); let currentLine = 0;
            function showNextLine() {
                if (currentLine < textLines.length) {
                    if (currentLine > 0) textLines[currentLine - 1].classList.remove('active');
                    textLines[currentLine].classList.add('active'); currentLine++;
                    if (currentLine === textLines.length) setTimeout(triggerEyeOpen, 4000); else setTimeout(showNextLine, 3500);
                }
            }
            function triggerEyeOpen() {
                textLines.forEach(l => l.classList.remove('active')); document.getElementById('eye-open-light').classList.add('active');
                setTimeout(() => { document.getElementById('fin-text').classList.add('active'); setTimeout(() => { document.getElementById('ending-skip').style.opacity = '1'; }, 2000); }, 2500);
            }
            setTimeout(showNextLine, 1000);
        }

        function showResult() {
            Sound.stopBGM(); 
            document.getElementById('play-screen').classList.add('hidden'); document.getElementById('play-screen').classList.remove('flex');
            document.getElementById('pause-btn-global').classList.add('hidden'); document.getElementById('game-container').classList.remove('panic-mode');
            
            if (state.difficulty === 'endless') {
                document.getElementById('result-rank').classList.add('hidden'); document.getElementById('result-status').innerText = "GAME OVER"; document.getElementById('result-status').classList.add('text-red-500');
                document.getElementById('result-stat-label').innerText = "STAGES CLEARED";
                const clearedStages = state.currentStep - 1; document.getElementById('total-change-coins').innerText = `${clearedStages} STAGES`;
                const best = localStorage.getItem('endless_best_stage') || 0; if (clearedStages > best) { localStorage.setItem('endless_best_stage', clearedStages); document.getElementById('new-record-badge').classList.remove('hidden'); } else document.getElementById('new-record-badge').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
            } else {
                let rankId = "pan-man"; let rankName = "è²¡å¸ƒãƒ‘ãƒ³ãƒ‘ãƒ³ãƒãƒ³";
                if (state.difficulty === 'nightmare' && state.totalChangeCoins <= 10) { rankId = "nightmare-god"; rankName = "å¤¢ã‚’è¶…ãˆã¦ãƒ»ãƒ»ãƒ»"; }
                else if (state.totalChangeCoins <= 20) { if (state.difficulty === 'nightmare') rankId = "nightmare-conqueror"; else if (state.difficulty === 'hard') rankId = "hard-god"; else rankId = "normal-god"; }
                else if (state.totalChangeCoins <= 30) rankId = "god"; else if (state.totalChangeCoins <= 50) rankId = "wizard"; else if (state.totalChangeCoins <= 70) rankId = "normal"; else if (state.totalChangeCoins <= 90) rankId = "heavy";
                
                rankName = ALL_TITLES.find(t => t.id === rankId)?.name || rankName;
                const isNewTitle = saveEarnedTitle(rankId);
                let isNewCollector = false;
                const earned = getEarnedTitles(); const requirements = ALL_TITLES.filter(t => t.rarity === 'rare' || t.rarity === 'common').map(t => t.id);
                if (requirements.every(req => earned.includes(req))) { 
                    isNewCollector = saveEarnedTitle("collector-king");
                    if (isNewCollector) { rankId = "collector-king"; rankName = "å…¨çŸ¥å…¨èƒ½ã®å®¢"; }
                }
                
                if (rankId === "nightmare-god" && !state.isEnding) { playEnding(); return; }
                
                document.getElementById('result-rank').classList.remove('hidden');
                document.getElementById('result-status').innerText = "STAGE COMPLETE"; document.getElementById('result-status').classList.remove('text-red-500');
                document.getElementById('result-stat-label').innerText = "TOTAL CHANGE COINS";
                document.getElementById('final-rank-text').innerText = rankName; document.getElementById('total-change-coins').innerText = `${state.totalChangeCoins}æš`;
                
                const titleBadge = document.getElementById('new-title-badge');
                if (isNewTitle || isNewCollector) titleBadge.classList.remove('hidden');
                else titleBadge.classList.add('hidden');
                
                document.getElementById('new-record-badge').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                if (rankId === "collector-king" || earned.includes("collector-king")) {
                    document.getElementById('nightmare-hint').classList.remove('hidden');
                }
            }
        }
    </script>
</body>
</html>